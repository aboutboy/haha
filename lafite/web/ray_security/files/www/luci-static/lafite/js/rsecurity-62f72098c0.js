(function(){"use strict";var n;n=angular.module("pandorabox.pages"),n.register.controller("RSecurityController",["$scope","$rootScope","$http","$interval","$q","$UCI","FloatDiv","Fn","Status","$timeout",function(n,e,t,o,r,a,i,c,l,u){var s,g,d,f,m,p;m=null,p=function(n,e,r,a){var i,c;return(angular.isUndefined(a)||null===a)&&(a=1e3),angular.isString(n)&&0!==n.length?"number"!=typeof a||a<0?console.warn("Delay is Error."):(c=!1,i=!1,void(m=o(function(){c||(c=!0,t.get(n).success(function(n){c=!1,i&&(o.cancel(m),null!=e&&angular.isFunction(e)&&e(n))}).error(function(n){c=!1,i=!0,r&&angular.isFunction(r)&&r(n)}))},a))):console.warn("Url is Error.")},n.isReboot=!1,n.rebootPre="0%",n.action_reboot=function(){var e,t,r;n.isReboot||(e=0,confirm(c.getTranslate("Reboot?"))&&(a.$command("NOHUP reboot","now"),n.isReboot=!0,(t=function(e){n.rebootStyle={width:e+"%"},n.rebootPre=e.toFixed(0)+" %"})(e),r=o(function(){var n,a;e+=.5,t(e),e<=97||(o.cancel(r),a=[],n=c.ping("/",function(o){e<=99&&(e+=.3,t(e)),a.push(!0),a.length>3&&-1===a.slice(-3).indexOf(!1)&&(n.cancel(),l.login={},window.localStorage.setItem("ray_user",{}),window.location.href="/")},function(){return e<=99&&(e+=.3,t(e)),a.push(!1)}))},333)))},d=function(n,e){var t;return null==e&&(e=!0),e||(t="-n"),i.once("正在升级...期间与路由器的链接将会断开!"),a.$command(["NOHUP killall dropbear uhttpd","NOHUP /sbin/sysupgrade "+(null!=t?t:"")+" "+n,"NOHUP reboot"],"now"),p("/",function(){u(function(){l.login={},window.localStorage.setItem("user",JSON.stringify({})),window.location="/"},45e3)},function(){c.getBrowserInfo().mobile&&alert(c.getTranslate("wirelessDisconnect"))},1e3)},n.version="",n.isExistLatestVersion=!1,function(){var t,i,c;return c=null,i=!1,e.$on("page.main.current",function(n,e){"rsecurity"===e&&null!=c&&o.cancel(c)}),(t=function(){return i?r.reject():(i=!0,a.$command(["GET ubus call upgrade version","GET ubus call upgrade version_q"],"now").then(function(e){var t,r,a,l,u,s;if(i=!1,"ok"===e.status){for(t=e.commands,r=0,l=t.length;r<l;r++)if(a=t[r],0===a.content.length)return!1;switch(s=JSON.parse(t[0].content.join("")),u=JSON.parse(t[1].content.join("")),n.version=s.data.version,u.errorcode){case"0":o.cancel(c),c=null,n.isExistLatestVersion=!0;break;case"1500":}}}))})(),c=o(t,5e3)}(),n.action_net=function(){var n,e,t,r,c;return t=!1,r=null,e=null,n=null,c=function(){return d(e.path,"undefined"==typeof keepFlag||null===keepFlag||keepFlag)},function(){var l;(l=function(){var l;return!t&&(t=!0,l=["GET ubus call upgrade download_q"],null!=e&&l.push("GET ls -l "+e.path),a.$command(l,"now").then(function(a){var l,s,g;if(t=!1,"ok"===a.status){if(l=JSON.parse(a.commands[0].content.join("")),2===a.commands.length&&0!==a.commands[1].content.length&&(g=a.commands[1].content[0].split(/\s+/),s=(+g[4]/+e.size).toFixed(2),i.setText("已下载......"+100*s+"%"),g[4]===e.size))return o.cancel(r),r=null,n(),void(confirm("下载完成, 是否开始升级?")&&c());switch(l.errorcode){case"0":return null==e&&(n=i.once("下载中......")),null!=e?e:e={path:l.data.path,size:l.data.size};case"1501":break;case"1510":return o.cancel(r),r=null,i.setText("空间不足!"),u(n,2e3);case"1511":return o.cancel(r),r=null,i.setText("下载失败, 请检查网络!"),u(n,2e3)}}}))})(),r=o(l,3e3)}}(),g=angular.element(document.getElementById("image")),g.bind("change",function(){var n,e;null!==g.val()&&""!==g.val()&&(n=function(){return r(function(n,e){var t;return t=o(function(){var r,a,i;if(r=document.getElementsByName("_frm_upgrade")[0].contentWindow.document.body,angular.isString(r.innerHTML)&&0!==r.innerHTML.length&&r.getElementsByTagName("pre")&&(i=r.getElementsByTagName("pre")[0],angular.isString(i.innerHTML)&&0!==i.innerHTML.length)){a={};try{a=JSON.parse(i.innerHTML)}catch(c){e(a)}return"ok"===a.status?(i.innerHTML="",n(a)):(i.innerHTML="",e(a)),o.cancel(t)}},50)})},e=i.once(),document.getElementById("frm_upgrade").submit(),n().then(function(){var n;return document.getElementById("image").value=null,e(),n=confirm(c.getTranslate("KeepConfig?")),d("/tmp/update.file",n)},function(){document.getElementById("image").value=null,e()}))}),n.action_local=function(){document.getElementById("image").click()},n.isError=!1,f=n.passwords={OLD:"",NEW:"",RENEW:""},s=function(){return"/cgi-bin/luci/pbr/auth?_c="+(new Date).getTime()},n.action_change=function(){var e,o;return f.NEW===f.RENEW&&8<=(o=f.NEW.length)&&o<=32&&f.OLD!==f.NEW?(e=i.once(),t.post(s(),{action:"change",username:"root",password:f.OLD,change:f.NEW}).success(function(t){var o;e(),"ok"===t.status?(f=n.passwords={OLD:"",NEW:"",RENEW:""},l.login={},window.localStorage.setItem("user",JSON.stringify({})),window.location.href="/"):(n.passwords.OLD="",n.isError=!0,u(function(){var n;return null!=(n=document.getElementsByName("oldPassword")[0])?n.focus():void 0},500),o=n.$watch("passwords.OLD",function(e){0!==e.length&&(o(),n.isError=!1)}))}).error(function(){})):r.reject()}}])}).call(this);
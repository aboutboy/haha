(function(){"use strict";var a;a=angular.module("pandorabox.pages"),a.register.controller("IpListController",["$scope","$rootScope","Status","$UCI","Fn","$filter","FloatDiv","$timeout",function(a,e,n,t,i,r,c,s){var o,f,d,p,l,h,u,m;null==n.dhcpStaticList&&(n.dhcpStaticList={}),d=[],l=[],a.dhcp=null!=(h=n.dhcpStaticList)?h:{},a.newData={},a.newFlag=!1,a.hasData=!1,a.autoLink=!0,a.clearFlag=f=function(){return a.newFlag=!a.newFlag,a.showIP=!1,a.showMAC=!1,a.showName=!1,a.autoLink=!0,a.newData={},!0},o=function(){var e,n,t;a.hasData=!1,n=a.dhcp;for(e in n)if(t=n[e],/cfg/.test(e)&&/host/.test(t[".type"])){a.hasData=!0;break}m()},(u=function(){t.$sync(["dhcp","lafite"]).then(function(e){var n,i,r,c,s,p,l;if(d=null!=(c=t.$Native.lafite.rclientlist.list)?c:[],f(),a.newFlag=!1,angular.isUndefined(a.dhcp))a.dhcp=angular.copy(e.dhcp);else{s=t.dhcp;for(i in s)l=s[i],(angular.isUndefined(a.dhcp[i])||l!==a.dhcp[i])&&(a.dhcp[i]=angular.copy(l));p=a.dhcp;for(r in p)n=p[r],angular.isUndefined(t.dhcp[r])&&delete a.dhcp[r]}o()})})(),(p=function(){var a,e,n;a=[],n=[],e=["GET cat /proc/net/arp","GET cat /tmp/dhcp.leases"],t.$command(e,"now").then(function(e){var t,c,s,o,f,d,p,l,h,u,m,g,w,D,v,k,L,U,y,b,$;if("ok"===e.status&&angular.isArray(e.commands)){for(k=e.commands,f=0,u=k.length;f<u;f++)s=k[f],/arp/gi.test(s.command)?c=s.content:/dhcp/gi.test(s.command)&&(o=s.content);if(angular.isDefined(c))for(p=0,m=c.length;p<m;p++)if(t=c[p],!/ip/gi.test(t)&&(y=t.split(/\s+/),0!==y.length&&(y[3]=y[3].toUpperCase(),!/00:00:00:00:00:00/.test(y[3])&&!/00-00-00-00-00-00/.test(y[3])&&/lan/.test(y[5])))){for(b=!1,l=0,g=a.length;l<g;l++)if($=a[l],$.mac===y[3]){b=!0;break}if(b)continue;a.push({ip:y[0],mac:y[3]})}if(angular.isDefined(o))for(h=0,w=o.length;h<w;h++)d=o[h],v=d.match(/^(\d+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)/),!angular.isUndefined(v)&&v&&(v[1]=1e3*+v[1]-new Date,v[1]=r("date")(v[1],"HH:mm:ss","+0000"),v[2]=v[2].toUpperCase(),D={expires:v[1],mac:null!=(L=v[2])?L:"00:00:00:00:00:00",ip:null!=(U=v[3])?U:"255.255.255.255",devtype:i.getMacInfo(v[2]).devtype},angular.isDefined(v[4])?D.name=v[4]:D.name=i.getMacInfo(v[2]).brand,n.push(D))}}).then(function(){var e,t,r,c,s,o,f,p,h,u,g,w,D,v;if(l=[],0!==a.length)for(o=0,u=a.length;o<u;o++){for(e=a[o],c=!1,f=0,g=n.length;f<g;f++)if(r=n[f],e.mac===r.mac){c=!0,l.push(r);break}c||(v=i.getMacInfo(e.mac),l.push({expires:-1,mac:e.mac,ip:e.ip,name:v.brand,devtype:v.devtype}))}else l=n;for(p=0,w=d.length;p<w;p++)for(t=d[p],h=0,D=l.length;h<D;h++)if(s=l[h],-1!==t.indexOf(s.mac)){s.name=t.split("=")[1];break}m()})})(),m=function(){var e,n,t,i,r,c,s;for(a.hostList=angular.copy([]),t=0,c=l.length;t<c;t++){n=l[t],e=!1,s=a.dhcp;for(i in s)if(r=s[i],!/del/.test(i)&&!/add/.test(i)&&/cfg/.test(i)&&/host/.test(r[".type"])&&r.mac===n.mac){e=!0;break}e||a.hostList.push(n)}},a.showName=!1,a.customerName=function(){var e,n,t,i;if(!angular.isUndefined(a.newData.name)&&0!==a.newData.name.length){if("cname"===a.newData.name)return a.showName=!0,a.autoLink=!1,void(a.newData.name="");if(a.autoLink)for(i=a.hostList,e=0,t=i.length;e<t;e++)if(n=i[e],n.name===a.newData.name){a.newData.ip=n.ip,a.newData.mac=n.mac;break}}},a.showIP=!1,a.customerIP=function(){var e,n,t,i;if(!angular.isUndefined(a.newData.ip)&&0!==a.newData.ip.length){if("0.0.0.0"===a.newData.ip)return a.showIP=!0,a.newData.ip="",void(a.autoLink=!1);if(a.autoLink)for(i=a.hostList,e=0,t=i.length;e<t;e++)if(n=i[e],n.ip===a.newData.ip){a.newData.mac=n.mac,a.newData.name=n.name,""===n.name&&(a.showName=!0);break}}},a.showMAC=!1,a.customerMAC=function(){var e,n,t,i;if(!angular.isUndefined(a.newData.mac)&&0!==a.newData.mac.length){if("00:00:00:00:00:00"===a.newData.mac)return a.newData.mac="",a.showMAC=!0,void(a.autoLink=!1);if(a.autoLink)for(i=a.hostList,e=0,t=i.length;e<t;e++)if(n=i[e],n.mac===a.newData.mac){a.newData.ip=n.ip,a.newData.name=n.name,""===n.name&&(a.showName=!0);break}}},a["delete"]=function(e,n){var i;return!angular.isUndefined(n)&&(i=c.once(),/cfg/.test(e)?(t.$del("dhcp",n[".name"]),delete a.dhcp[n[".name"]]):/add/.test(e)&&(t.$revert("dhcp",e),delete a.dhcp[e]),i(),o(),!0)},a.submit=function(a,e){var n,r,o,f,d,p,l,h;if(angular.isUndefined(t.dhcp))return!1;if(!/cfg/.test(a))return!1;if("host"!==e[".type"])return!1;n=0,l=t.dhcp;for(d in l)if(p=l[d],"host"===p[".type"]&&(p.mac!==e.mac&&p.ip!==e.ip||(n+=1),!(n<2)))return t.$revert("dhcp"),u(),!1;h={};for(o in e){if(f=e[o],/ip/.test(o)&&!i.isIP(f))break;if(/mac/.test(o)&&!i.isMAC(f))break;t.dhcp[a][o]!==f&&(h[o]=f)}return!(angular.isUndefined(h.ip)&&angular.isUndefined(h.mac)&&angular.isUndefined(h.name))&&(r=c.once(),t.$set("dhcp",a,h),s(function(){return u(),r()},1e3),!0)},a.add=function(){var e,n,r,o,f,d,p,l,h,m,g;for(p=["name","ip","mac"],r=0,l=p.length;r<l;r++){if(o=p[r],angular.isUndefined(a.newData[o]))return a.newFlag=!1,!1;if(0===a.newData[o].length)return a.newFlag=!1,!1}if(m=Math.random().toString().slice(-5),h={".type":"host",name:a.newData.name,ip:a.newData.ip,mac:a.newData.mac},!i.isIP(h.ip)||!i.isMAC(h.mac))return a.newData={},a.newFlag=!1,!1;e=0,g=a.dhcp;for(f in g)if(d=g[f],"host"===d[".type"]&&(d.mac!==h.mac&&d.ip!==h.ip||(e+=1),!(e<1)))return a.newData={},a.newFlag=!1,!1;return n=c.once(),t.$add("dhcp",m,h),s(function(){return u(),n(),a.newData={}},1e3),!0},e.$on("page.main.current",function(e,t){"iplist"===t&&(n.dhcpStaticList=a.dhcp)})}])}).call(this);
(function(){"use strict";var t;t=angular.module("pandorabox.pages"),t.register.service("PBClientList",["$rootScope","$q","$filter","$interval","Fn","$UCI",function(t,e,n,r,a,l){var i,s,o,c,u,f,d,h,p,m,v,g,w,$,y,N,j,C,b,S,x,G;return p=!1,G=[],y=[],c="",x=null,m={port:{},arp:{},wireless:{},dhcp:{},host:{}},this.init=function(){return p?j():d().then(function(){return p=!0}).then(j)},this.getConfig=function(){return{isInit:p,wirelessDeviceList:G,portsList:y,dhcpFilePath:c}},this.getClinetItem=function(t){var e;return null!=t&&angular.isString(t)&&""!==t?(m=f({arp:!0,dhcp:!0,port:!0,wireless:!0,allInfo:!1}),m=function(){var n,r,a;for(a=[],n=0,r=m.length;n<r;n++)e=m[n],e.macaddr===t&&a.push(e);return a}(),0!==m.length?m[0]:{}):{}},this.getClientName=function(t){var e,n,r,a;if(a="","undefined"==typeof macaddr||null===macaddr||!angular.isString(macaddr)||""===macaddr)return a;for(m=f({dhcp:!0,allInfo:!0}),e=0,r=m.length;e<r;e++)if(n=m[e],n.macaddr===macaddr){a=n.hostname;break}return a},this.setClientName=function(t,n){var r,a,i,s;if(null==n&&(n=""),null==t||!angular.isString(t)||""===t)return e.reject("Wrong Mac Address");if(!angular.isString(n))return e.reject("Wrong Client Name");if(i=null!=(s=m.host[t])?s:{},n.length>0){if(a=n,a.length>32&&(a=a.substring(0,32)),i.hostname===a)return e.reject("Hostname is the same");i.hostname=a}else{if(null==i.hostname)return e.reject("Hostname isnt Exist");delete i.hostname}return l.$set("lafite","common_clientlist",{hosts:function(){var t,e;t=m.host,e=[];for(r in t)i=t[r],e.push(JSON.stringify(i));return e}()}),l.$getAutoSave()?e.resolve("Client Name Update"):l.$save("lafite")},f=this.getList=function(t){var e,n,r,l,i,s,o,c,u,f,d,h,p;if(null==t&&(t={arp:!0,dhcp:!0,port:!0,wireless:!0}),null==t.allInfo&&(t.allInfo=!1),(t.wireless||t.port)&&(t.arp=!0),n={},t.arp){o=m.arp;for(i in o){s=o[i],null==n[i]&&(n[i]={});for(l in s)p=s[l],n[i][l]=p}}if(t.wireless){r=!1,angular.isString(t.wireless)&&(r=!0),c=m.wireless;for(i in c)if(s=c[i],!r||s.device===t.wireless){null==n[i]&&(n[i]={});for(l in s)p=s[l],n[i][l]=p}}if(t.port){u=m.port;for(i in u){s=u[i],null==n[i]&&(n[i]={});for(l in s)p=s[l],n[i][l]=p}}if(t.dhcp){f=m.dhcp;for(i in f){s=f[i],null==n[i]&&(n[i]={});for(l in s)p=s[l],n[i][l]=p}}if(!t.allInfo&&(t.wireless||t.port))for(i in n)s=n[i],t.wireless&&"wireless"===s.type||t.port&&"lan"===s.type||delete n[i];for(i in n)s=n[i],n[i].devtype=a.getMacInfo(s.macaddr).devtype,"lan"===s.type&&(n[i].devtype="notebook");d=m.host;for(i in d)if(s=d[i],null!=n[i])for(l in s)p=s[l],n[i][l]=p;return function(){var t;t=[];for(e in n)h=n[e],t.push(h);return t}()},d=function(){var t,n,r;return t=l.$sync(["lafite","dhcp","wireless"]).then(function(){var t,e,n,r,a,i,s,o,u,f,d,h,p,v,g,w,$,y;for(h=null!=(f=null!=(d=l.$Native.lafite.common_clientlist)?d.hosts:void 0)?f:[],n=0,o=h.length;n<o;n++)a=h[n],u=JSON.parse(a),m.host[u.macaddr]=u;p=l.$Native.wireless;for(s in p)y=p[s],/^cfg/.test(s)||("rtwifi"===y.type?(e=function(){var t,e;t=l.$Native.wireless,e=[];for(i in t)$=t[i],/^cfg/.test(i)&&$.device===s&&e.push($);return e}(),e=function(){var n,a,l;for(l=[],r=n=0,a=e.length;n<a;r=++n)t=e[r],l.push(""+s+r);return l}(),G=G.concat(e)):G.push(s));v=l.$Native.wireless;for(s in v)y=v[s],/^cfg/.test(s)&&"ap"===y.mode&&null!=y.ifname&&G.push(y.ifname);g=l.$Native.dhcp,w=[];for(s in g)if(y=g[s],"dnsmasq"===y[".type"]&&null!=y.leasefile){c=y.leasefile;break}return w}),n=l.$command("GET cat /etc/board.json","now").then(function(t){var e,n,r,a,l,i,s;if(0!==t.commands[0].content.length){try{r=JSON.parse(t.commands[0].content.join(""))}catch(o){e=o,r={}}return a=null!=(l=null!=r&&null!=(i=r["switch"])&&null!=(s=i.switch0)?s.ports:void 0)?l:[],y=function(){var t,e,r;for(r=[],t=0,e=a.length;t<e;t++)n=a[t],null!=n.role&&"lan"===n.role&&r.push(n.num+"");return r}()}}),r=[t,n],e.all(r)},g=function(t){var n,r,a,i,s,o,c,u,f,d,h,p;if(r=t.command.match(/^GET iwinfo (.*) assoclist$/)[1],null==t.content||t.content.length<=1)return e.resolve(r);for(s=null==l.$Native.wireless[r],u=t.content,i=a=0,o=u.length;a<o;i=++a)n=u[i],/^(\w{2}:){5}\w{2}/.test(n)&&(c=n.match(/^((?:[\da-f]{2}:){5}[\da-f]{2}).*?(\d+)\s+ms\s+ago/i),!angular.isUndefined(c)&&c&&(c={rx:null!=(f=t.content[i+1].match(/rx:\s+(\d+.*?\/s)/i)[1])?f:null,tx:null!=(d=t.content[i+2].match(/tx:\s+(\d+.*?\/s)/i)[1])?d:null,macaddr:null!=(h=c[1].toUpperCase())?h:"00:00:00:00:00:00",time:null!=(p=c[2])?p:"-1",device:r,guest:s,type:"wireless"},m.wireless[c.macaddr]=c));return e.resolve(r)},w=function(t,r){var a,l,i,s,o,c,u,f;for(c=null!=(o=t.content)?o:[],a=0,i=c.length;a<i;a++)l=c[a],s=l.split(/\s+/),!angular.isUndefined(s)&&s&&(s={expires:n("date")(1e3*(+s[0]-r),"HH:mm:ss","+0000"),macaddr:null!=(u=s[1].toUpperCase())?u:"00:00:00:00:00:00",ipaddr:null!=(f=s[2])?f:"255.255.255.255",hostname:s[3],duid:s[4]},m.dhcp[s.macaddr]=s);return e.resolve("dhcp")},v=function(t){var n,r,a,l,i;for(i=t.content,n=0,a=i.length;n<a;n++)r=i[n],/^(\d+\.){3}\d+/.test(r)&&(l=r.split(/\s+/),0!==l.length&&(l={ipaddr:l[0],macaddr:l[3].toUpperCase()},m.arp[l.macaddr]=l));return e.resolve("arp")},$=function(t){var n,r,a,l,i,s,o;for(s=null!=(i=t.content)?i:[],n=0,a=s.length;n<a;n++)r=s[n],l={type:"lan"},o=r.split(/\s+/),l.port=o[0],l.macaddr=o[1],l.macaddr=l.macaddr.toUpperCase(),-1!==y.indexOf(l.port)&&(l.portIndex=y.indexOf(l.port),m.port[l.macaddr]=l);return e.resolve("lan")},b=function(){var t,n,r,a,i,s,o,c,u,d;for(a=!1,r=f(),n=function(){var t,e,n;for(n=[],t=0,e=r.length;t<e;t++)s=r[t],null!=s.port&&n.push(s);return n}(),i=0,c=n.length;i<c;i++)s=n[i],null==m.host[s.macaddr]&&(d={macaddr:s.macaddr,type:s.type},m.host[s.macaddr]=d,a=!0);for(n=function(){var t,e,n;for(n=[],t=0,e=r.length;t<e;t++)s=r[t],null!=s.rx&&n.push(s);return n}(),o=0,u=n.length;o<u;o++)s=n[o],null==m.host[s.macaddr]&&(d={macaddr:s.macaddr,type:s.type},m.host[s.macaddr]=d,a=!0);return a?(l.$set("lafite","common_clientlist",{hosts:function(){var e,n;e=m.host,n=[];for(t in e)s=e[t],n.push(JSON.stringify(s));return n}()}),l.$getAutoSave()?e.resolve("sync update"):l.$save("lafite")):e.resolve("sync")},s=5,i=8e3,h=!1,N=0,u=0,S=function(){var n,a,f,d,p;if(null!=x)return e.reject();for(n=["GET date +'%s'"],d=0,p=G.length;d<p;d++)a=G[d],n.push("GET iwinfo "+a+" assoclist");return c.length>0&&n.push("GET cat "+c),n.push("GET cat /proc/net/arp"),n.push("GET switch dump-portmac"),f=function(){return h?e.reject("Getting Data"):(h=!0,l.$command(n,"now")["catch"](function(){return h=!1,e.reject("Get Data Fail")}).then(function(t){return o().then(function(){return t})}).then(function(t){var n,r;return"ok"!==t.status?e.reject():(r=function(){var r,a,l,i;for(l=t.commands,i=[],r=0,a=l.length;r<a;r++)switch(n=l[r],!1){case!/assoclist$/.test(n.command):i.push(g(n));break;case"GET cat /proc/net/arp"!==n.command:i.push(v(n));break;case"GET cat "+c!==n.command:i.push(w(n,N));break;case!/\sdate\s/.test(n.command):N=+n.content[0],i.push(e.resolve(N));break;case!/dump-portmac$/.test(n.command):i.push($(n));break;default:continue}return i}(),e.all(null!=r?r:[]))}).then(function(){return t.$broadcast("PBClientListUpdate",!0)}).then(function(){return u!==s?u++:u=0,(0===u?l.$command("switch clear","now"):e.resolve("clear"))["finally"](function(){return h=!1})}).then(b))},x=r(f,i),e.all([f(),x])},j=this.start=function(){return p?null!=x?e.reject():S():e.reject()},C=this.stop=function(){return null==x?e.reject():(r.cancel(x),x=null,e.resolve())},o=this.clear=function(){return m.port={},m.arp={},m.dhcp={},m.wireless={},e.resolve()},t.$on("page.main.current",function(){C()}),this}])}).call(this),function(){"use strict";var t;t=angular.module("pandorabox.pages"),t.register.service("PBClientList",["$rootScope","$q","$filter","$interval","Fn","$UCI",function(t,e,n,r,a,l){var i,s,o,c,u,f,d,h,p,m,v,g,w,$,y,N,j,C,b,S,x,G;return p=!1,G=[],y=[],c="",x=null,m={port:{},arp:{},wireless:{},dhcp:{},host:{}},this.init=function(){return p?j():d().then(function(){return p=!0}).then(j)},this.getConfig=function(){return{isInit:p,wirelessDeviceList:G,portsList:y,dhcpFilePath:c}},this.getClinetItem=function(t){var e;return null!=t&&angular.isString(t)&&""!==t?(m=f({arp:!0,dhcp:!0,port:!0,wireless:!0,allInfo:!1}),m=function(){var n,r,a;for(a=[],n=0,r=m.length;n<r;n++)e=m[n],e.macaddr===t&&a.push(e);return a}(),0!==m.length?m[0]:{}):{}},this.getClientName=function(t){var e,n,r,a;if(a="","undefined"==typeof macaddr||null===macaddr||!angular.isString(macaddr)||""===macaddr)return a;for(m=f({dhcp:!0,allInfo:!0}),e=0,r=m.length;e<r;e++)if(n=m[e],n.macaddr===macaddr){a=n.hostname;break}return a},this.setClientName=function(t,n){var r,a,i,s;if(null==n&&(n=""),null==t||!angular.isString(t)||""===t)return e.reject("Wrong Mac Address");if(!angular.isString(n))return e.reject("Wrong Client Name");if(i=null!=(s=m.host[t])?s:{},n.length>0){if(a=n,a.length>32&&(a=a.substring(0,32)),i.hostname===a)return e.reject("Hostname is the same");i.hostname=a}else{if(null==i.hostname)return e.reject("Hostname isnt Exist");delete i.hostname}return l.$set("lafite","common_clientlist",{hosts:function(){var t,e;t=m.host,e=[];for(r in t)i=t[r],e.push(JSON.stringify(i));return e}()}),l.$getAutoSave()?e.resolve("Client Name Update"):l.$save("lafite")},f=this.getList=function(t){var e,n,r,l,i,s,o,c,u,f,d,h,p;if(null==t&&(t={arp:!0,dhcp:!0,port:!0,wireless:!0}),null==t.allInfo&&(t.allInfo=!1),(t.wireless||t.port)&&(t.arp=!0),n={},t.arp){o=m.arp;for(i in o){s=o[i],null==n[i]&&(n[i]={});for(l in s)p=s[l],n[i][l]=p}}if(t.wireless){r=!1,angular.isString(t.wireless)&&(r=!0),c=m.wireless;for(i in c)if(s=c[i],!r||s.device===t.wireless){null==n[i]&&(n[i]={});for(l in s)p=s[l],n[i][l]=p}}if(t.port){u=m.port;for(i in u){s=u[i],null==n[i]&&(n[i]={});for(l in s)p=s[l],n[i][l]=p}}if(t.dhcp){f=m.dhcp;for(i in f){s=f[i],null==n[i]&&(n[i]={});for(l in s)p=s[l],n[i][l]=p}}if(!t.allInfo&&(t.wireless||t.port))for(i in n)s=n[i],t.wireless&&"wireless"===s.type||t.port&&"lan"===s.type||delete n[i];for(i in n)s=n[i],n[i].devtype=a.getMacInfo(s.macaddr).devtype,"lan"===s.type&&(n[i].devtype="notebook");d=m.host;for(i in d)if(s=d[i],null!=n[i])for(l in s)p=s[l],n[i][l]=p;return function(){var t;t=[];for(e in n)h=n[e],t.push(h);return t}()},d=function(){var t,n,r;return t=l.$sync(["lafite","dhcp","wireless"]).then(function(){var t,e,n,r,a,i,s,o,u,f,d,h,p,v,g,w,$,y;for(h=null!=(f=null!=(d=l.$Native.lafite.common_clientlist)?d.hosts:void 0)?f:[],n=0,o=h.length;n<o;n++)a=h[n],u=JSON.parse(a),m.host[u.macaddr]=u;p=l.$Native.wireless;for(s in p)y=p[s],/^cfg/.test(s)||("rtwifi"===y.type?(e=function(){var t,e;t=l.$Native.wireless,e=[];for(i in t)$=t[i],/^cfg/.test(i)&&$.device===s&&e.push($);return e}(),e=function(){var n,a,l;for(l=[],r=n=0,a=e.length;n<a;r=++n)t=e[r],l.push(""+s+r);return l}(),G=G.concat(e)):G.push(s));v=l.$Native.wireless;for(s in v)y=v[s],/^cfg/.test(s)&&"ap"===y.mode&&null!=y.ifname&&G.push(y.ifname);g=l.$Native.dhcp,w=[];for(s in g)if(y=g[s],"dnsmasq"===y[".type"]&&null!=y.leasefile){c=y.leasefile;break}return w}),n=l.$command("GET cat /etc/board.json","now").then(function(t){var e,n,r,a,l,i,s;if(0!==t.commands[0].content.length){try{r=JSON.parse(t.commands[0].content.join(""))}catch(o){e=o,r={}}return a=null!=(l=null!=r&&null!=(i=r["switch"])&&null!=(s=i.switch0)?s.ports:void 0)?l:[],y=function(){var t,e,r;for(r=[],t=0,e=a.length;t<e;t++)n=a[t],null!=n.role&&"lan"===n.role&&r.push(n.num+"");return r}()}}),r=[t,n],e.all(r)},g=function(t){var n,r,a,i,s,o,c,u,f,d,h,p;if(r=t.command.match(/^GET iwinfo (.*) assoclist$/)[1],null==t.content||t.content.length<=1)return e.resolve(r);for(s=null==l.$Native.wireless[r],u=t.content,i=a=0,o=u.length;a<o;i=++a)n=u[i],/^(\w{2}:){5}\w{2}/.test(n)&&(c=n.match(/^((?:[\da-f]{2}:){5}[\da-f]{2}).*?(\d+)\s+ms\s+ago/i),!angular.isUndefined(c)&&c&&(c={rx:null!=(f=t.content[i+1].match(/rx:\s+(\d+.*?\/s)/i)[1])?f:null,tx:null!=(d=t.content[i+2].match(/tx:\s+(\d+.*?\/s)/i)[1])?d:null,macaddr:null!=(h=c[1].toUpperCase())?h:"00:00:00:00:00:00",time:null!=(p=c[2])?p:"-1",device:r,guest:s,type:"wireless"},m.wireless[c.macaddr]=c));return e.resolve(r)},w=function(t,r){var a,l,i,s,o,c,u,f;for(c=null!=(o=t.content)?o:[],a=0,i=c.length;a<i;a++)l=c[a],s=l.split(/\s+/),!angular.isUndefined(s)&&s&&(s={expires:n("date")(1e3*(+s[0]-r),"HH:mm:ss","+0000"),macaddr:null!=(u=s[1].toUpperCase())?u:"00:00:00:00:00:00",ipaddr:null!=(f=s[2])?f:"255.255.255.255",hostname:s[3],duid:s[4]},m.dhcp[s.macaddr]=s);return e.resolve("dhcp")},v=function(t){var n,r,a,l,i;for(i=t.content,n=0,a=i.length;n<a;n++)r=i[n],/^(\d+\.){3}\d+/.test(r)&&(l=r.split(/\s+/),0!==l.length&&(l={ipaddr:l[0],macaddr:l[3].toUpperCase()},m.arp[l.macaddr]=l));return e.resolve("arp")},$=function(t){var n,r,a,l,i,s,o;for(s=null!=(i=t.content)?i:[],n=0,a=s.length;n<a;n++)r=s[n],l={type:"lan"},o=r.split(/\s+/),l.port=o[0],l.macaddr=o[1],l.macaddr=l.macaddr.toUpperCase(),-1!==y.indexOf(l.port)&&(l.portIndex=y.indexOf(l.port),m.port[l.macaddr]=l);return e.resolve("lan")},b=function(){var t,n,r,a,i,s,o,c,u,d;for(a=!1,r=f(),n=function(){var t,e,n;for(n=[],t=0,e=r.length;t<e;t++)s=r[t],null!=s.port&&n.push(s);return n}(),i=0,c=n.length;i<c;i++)s=n[i],null==m.host[s.macaddr]&&(d={macaddr:s.macaddr,type:s.type},m.host[s.macaddr]=d,a=!0);for(n=function(){var t,e,n;for(n=[],t=0,e=r.length;t<e;t++)s=r[t],null!=s.rx&&n.push(s);return n}(),o=0,u=n.length;o<u;o++)s=n[o],null==m.host[s.macaddr]&&(d={macaddr:s.macaddr,type:s.type},m.host[s.macaddr]=d,a=!0);return a?(l.$set("lafite","common_clientlist",{hosts:function(){var e,n;e=m.host,n=[];for(t in e)s=e[t],n.push(JSON.stringify(s));return n}()}),l.$getAutoSave()?e.resolve("sync update"):l.$save("lafite")):e.resolve("sync")},s=5,i=8e3,h=!1,N=0,u=0,S=function(){var n,a,f,d,p;if(null!=x)return e.reject();for(n=["GET date +'%s'"],d=0,p=G.length;d<p;d++)a=G[d],n.push("GET iwinfo "+a+" assoclist");return c.length>0&&n.push("GET cat "+c),n.push("GET cat /proc/net/arp"),n.push("GET switch dump-portmac"),f=function(){return h?e.reject("Getting Data"):(h=!0,l.$command(n,"now")["catch"](function(){return h=!1,e.reject("Get Data Fail")}).then(function(t){return o().then(function(){return t})}).then(function(t){var n,r;return"ok"!==t.status?e.reject():(r=function(){var r,a,l,i;for(l=t.commands,i=[],r=0,a=l.length;r<a;r++)switch(n=l[r],!1){case!/assoclist$/.test(n.command):i.push(g(n));break;case"GET cat /proc/net/arp"!==n.command:i.push(v(n));break;case"GET cat "+c!==n.command:i.push(w(n,N));break;case!/\sdate\s/.test(n.command):N=+n.content[0],i.push(e.resolve(N));break;case!/dump-portmac$/.test(n.command):i.push($(n));break;default:continue}return i}(),e.all(null!=r?r:[]))}).then(function(){return t.$broadcast("PBClientListUpdate",!0)}).then(function(){return u!==s?u++:u=0,(0===u?l.$command("switch clear","now"):e.resolve("clear"))["finally"](function(){return h=!1})}).then(b))},x=r(f,i),e.all([f(),x])},j=this.start=function(){return p?null!=x?e.reject():S():e.reject()},C=this.stop=function(){return null==x?e.reject():(r.cancel(x),x=null,e.resolve())},o=this.clear=function(){return m.port={},m.arp={},m.dhcp={},m.wireless={},e.resolve()},t.$on("page.main.current",function(){C()}),this}])}.call(this);
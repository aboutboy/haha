(function(){"use strict";var e;e=angular.module("pandorabox.pages"),e.register.controller("WirelessRelayController",["$scope","$UCI",function(e,n){var t,i,r,s,c,a,l;i=[],l=[],e.relay={disabled:"0",mode:"sta",network:"wwan"},e.isExist=!1,e.list=[],r=function(){var e,t,r,s,c;if(0===i.length){r=n.wireless;for(e in r)c=r[e],"wifi-device"===c[".type"]&&(null!=c.disabled&&"0"!==c.disabled||i.push(c[".name"]))}else{s=n.wireless;for(e in s)c=s[e],"wifi-device"===c[".type"]&&(t=c[".name"],null==c.disabled||"0"===c.disabled?-1===i.indexOf(t)&&i.push(t):"1"===c.disabled&&-1!==i.indexOf(t)&&i.splice(i.indexOf(t),1))}return!0},a=function(){var t,i;l=function(){var e,r;e=n.wireless,r=[];for(t in e)i=e[t],null!=i.mode&&"sta"===i.mode&&r.push(i);return r}(),e.isExist=0!==l.length,e.isExist&&(e.relay=angular.copy(l[0]),e.relay.encryption=c(e.relay.encryption))},e.scan=function(){var t,r;return t=!1,r={},function(){var s,c,a,l;return!t&&(0!==i.length&&(t=!0,s=function(){var e,n,t,r;for(t=i.concat(i.concat(i)),r=[],e=0,n=t.length;e<n;e++)a=t[e],r.push(a);return r}(),(c=function(i){var r;return 0===i&&(e.list=[]),r=s[i],n.$command("GET iwinfo "+r+" scan","now").then(function(e){return l(e.commands[0].content,r)}).then(function(){if(i+1!==s.length)return c(i+1)}).then(function(){return t=!1})})(0),l=function(n,t){var i,s,c,a,l,u,d,o,y,f,p,h,m;if(null==n&&(n=[]),null==t&&(t=""),0===n.length)return!1;for(p=new Array(n.length/6),u=l=0,d=p.length;l<d;u=++l)i=p[u],o=n[6*u+0].match(/[A-F\d]{2}(:[A-F\d]{2}){5}$/)[0],m=n[6*u+1].match(/^\s+ESSID:\s+"?([^"].*?)"?$/)[1],y=n[6*u+2].match(/Mode:\s+(\w+)/)[1],c=+n[6*u+2].match(/\d+$/)[0],h=+n[6*u+3].match(/(-\d+) dBm/)[1],f=+n[6*u+3].match(/(\d+)\/\d+$/)[1],a=n[6*u+4].match(/^\s*Encryption:\s+(.*)$/)[1],null==r[m]&&(r[m]={ssid:m,devices:{}}),null==(s=r[m].devices)[o]&&(s[o]={mac:o,channel:c,signal:h,quality:f,encryption:a,device:t,hidden:!/"/.test(n[6*u+1])}),r[m].devices[o].signal=(r[m].devices[o].signal+h)/2,r[m].devices[o].quality=(r[m].devices[o].quality+f)/2,e.list=r;return!0},!0))}}(),e.addForm=function(n,t){var i;return e.isExist=!0,i=e.relay,(i.ssid!==t.ssid||i.device!==n.device||i.bssid!==n.bssid||i.channel!==n.channel||s(i.encryption)!==n.encryption||i.key!==n.key)&&(e.relay.ssid=t.ssid,e.relay.device=n.device,e.relay.bssid=n.mac,e.relay.channel=n.channel,e.relay.encryption=n.encryption,e.relay.key=n.key||"",!0)},t=e.connect=function(){var t,i;if(i={},"none"!==e.relay.encryption&&(null==e.relay.key||""===e.relay.key))return!1;if(0===l.length)i=e.relay,i.encryption=s(i.encryption),i[".type"]="wifi-iface",n.$add("wireless","1",i),a();else{if(t=l[0],i=e.relay,i.ssid===t.ssid&&i.device===t.device&&i.bssid===t.bssid&&i.channel===t.channel&&s(i.encryption)===t.encryption&&i.key===t.key)return!1;i.encryption=s(i.encryption),n.$set("wireless",t[".name"],i),a()}return!0},null!=n.wireless&&r(),n.$sync("wireless").then(r).then(a),s=function(e){var n;return n="",n+=function(){switch(!1){case"none"!==e:return"none";case!/^WPA2\s+PSK/i.test(e):return"psk2";case!/^WPA\s+PSK/i.test(e):return"psk";case!/^mixed\s+WPA\/WPA2\s+PSK/i.test(e):return"psk-mixed"}}(),n+=function(){switch(!1){case-1===e.indexOf("(CCMP)"):return"+ccmp";case-1===e.indexOf("(TKIP)"):return"+tkip";case-1===e.indexOf("(TKIP, CCMP)"):return"+tkip+ccmp"}}(),""===n?e:n},c=function(e){var n;return n="",n+=function(){switch(!1){case!/^psk-mixed/.test(e):return"mixed WPA/WPA2 PSK";case!/^psk2/.test(e):return"WPA2 PSK";case!/^psk/.test(e):return"WPA PSK";case!/^none/.test(e):return"none"}}(),n+=function(){switch(!1){case!/\+tkip+ccmp$/.test(e):return" (TKIP, CCMP)";case!/\+tkip$/.test(e):return" (TKIP)";case!/\+ccmp$/.test(e):return" (CCMP)"}}(),""===n?e:n}}])}).call(this);
(function(){"use strict";var e;e=angular.module("pandorabox.pages"),e.register.controller("RWirelessBasicController",["$scope","$rootScope","$timeout","$UCI","WirelessList","Status","WirelessEncryption","FloatDiv",function(e,i,t,s,l,n,r,a){var o,u,d,c,f;t(function(){return s.$setAutoSave(!0)},700),null==n.ray&&(n.ray={}),e.wireless=null!=(c=n.ray.wireless)?c:{},e.list={},e.warningShow=!1,o=null,u=null,l.init(),(f=function(){var i,t,s,n;o=l.getFreqlist(),u=l.getHtmodelist();for(s in o)n=o[s],null==(i=e.list)[s]&&(i[s]={}),e.list[s].freqlist=null!=n?n:[];for(s in u)n=u[s],null==(t=e.list)[s]&&(t[s]={}),e.list[s].htmodelist=null!=n?n:[];return!0})(),l.refresh().then(f),d=function(){var i,t,l,n,r,a,o,u,d,c;for(o=Object.keys(s.wireless).sort(),n=0,u=o.length;n<u;n++)if(a=o[n],!/^cfg/.test(a))for(e.wireless[a]=angular.copy(s.wireless[a]),r=0,d=o.length;r<d;r++)c=o[r],/^cfg/.test(c)&&s.wireless[c].device===a&&(e.wireless[c]=angular.copy(s.wireless[c]),null==(i=e.wireless[c]).disabled&&(i.disabled="0"),"0"===e.wireless[c].disabled?null==(t=e.wireless).enabled&&(t.enabled=!0):null==(l=e.wireless).enabled&&(l.enabled=!1));return!0},null!=s.wireless&&d(),s.$sync(["wireless"]).then(d),e.encryptionList=r,e.submit=function(){var i,t,l,n,r,o,u,d,c,f,h,w,v,m,b,p,g,$,y,S,k;if(o=a.setFloatDiv(500),t=function(){var i,t;i=e.wireless,t=[];for(w in i)k=i[w],-1!==w.indexOf("cfg")&&"ap"===k.mode&&(null!=k.isolated&&"1"===k.isolated||t.push(k));return t}(),r=s.$getAutoSave(),s.$setAutoSave(!1),s.$revert("wireless"),e.wireless.enabled){for(n=[],d=0,v=t.length;d<v;d++){i=t[d],g={},$=s.$Native.wireless[i[".name"]];for(w in $)k=$[w],/^\./.test(w)||null!=i[w]&&k!==i[w]&&(g[w]=i[w]);g.disabled="0",null!=g.disabled&&delete g.disabled,"none"===i.encryption?null!=g.key&&delete g.key:g.key=e.wireless[i[".name"]].key,-1===n.indexOf(i.device)&&n.push(i.device),s.$set("wireless",i[".name"],g)}for(y=n.map(function(i){return e.wireless[i]}),f=0,m=y.length;f<m;f++){l=y[f],g={},S=s.$Native.wireless[l[".name"]];for(w in S)k=S[w],/^\./.test(w)||(null!=l[w]&&k!==l[w]&&(g[w]=l[w]),null!=g.disabled&&delete g.disabled);null!=g.channel&&(p=e.list[l[".name"]].htmodelist,"165"===g.channel?g.htmode="HT20":(u=s.$Native.wireless[l[".name"]].htmode,"HT20"===u?g.htmode=p[p.length-1]:g.htmode=u)),s.$set("wireless",l[".name"],g)}}for(c=h=0,b=t.length;h<b;c=++h)i=t[c],s.$set("wireless",i[".name"],{disabled:e.wireless.enabled?"0":"1"});return r&&(s.$save("wireless"),e.mainForm.$setPristine(),a.clearByID(o)),s.$setAutoSave(r),!0}}]),e.register.service("WirelessList",["$UCI","Status",function(e,i){var t,s,l,n,r,a,o;return s=null,l=null,t=[],this.init=function(){return(null==s||null==l||0===t.length)&&(a(),!0)},this.refresh=function(){var i;return i=[],e.$sync(["lafite","wireless"]).then(a).then(function(){var e,s,l,n;for(n=[],s=0,l=t.length;s<l;s++)e=t[s],i.push("GET iwinfo "+e+" freqlist"),n.push(i.push("GET iwinfo "+e+" htmodelist"));return n}).then(function(){return e.$command(i,"now")}).then(function(e){var i,t,s,l,a,o,u,d,c;for(o=e.commands,d=[],s=0,l=o.length;s<l;s++)if(i=o[s],a=i.command.match(/GET\s+iwinfo\s+(\w+)\s+(\w+list)$/))switch(u=[a[1],a[2]],t=u[0],c=u[1],c){case"freqlist":d.push(n(t,i.content));break;case"htmodelist":d.push(r(t,i.content));break;default:d.push(void 0)}return d}).then(o)},this.getFreqlist=function(){var e;return null!=(e=null!=s?s[i.board.id]:void 0)?e:{}},this.getHtmodelist=function(){var e;return null!=(e=null!=l?l[i.board.id]:void 0)?e:{}},n=function(e,t){var l,n,r,a;return 1!==t.length&&(null==s[r=i.board.id]&&(s[r]={}),s[i.board.id][e]=n=function(){var e,i,s;for(s=[],e=0,i=t.length;e<i;e++)l=t[e],-1===l.indexOf("unknown")&&(a=l.match(/^[*\s]+(\w.+ (\d+).+$)/),a&&s.push({key:a[1],val:a[2]}));return s}(),!0)},r=function(e,t){var s;return 0!==t.length&&(null==l[s=i.board.id]&&(l[s]={}),l[i.board.id][e]=t[0].match(/\S+/g),!0)},a=function(){var n,r,a,o;return null!=(null!=(o=e.lafite)?o.rwireless_basic:void 0)&&(n=e.lafite.rwireless_basic.freqlist||"{ }",s=JSON.parse(n),null==s[i.board.id]&&(s[i.board.id]={}),r=e.lafite.rwireless_basic.htmodelist||"{ }",l=JSON.parse(r),null==l[i.board.id]&&(l[i.board.id]={})),null!=e.wireless&&(t=function(){var i;i=[];for(a in e.$Native.wireless)/^cfg/.test(a)||i.push(a);return i}()),!0},o=function(){var t,n;if(t=e.lafite.rwireless_basic.freqlist||"{ }",t=JSON.parse(t),n=e.lafite.rwireless_basic.htmodelist||"{ }",n=JSON.parse(n),t[i.board.id]=s[i.board.id],n[i.board.id]=l[i.board.id],e.$set("lafite","rwireless_basic",{freqlist:JSON.stringify(t),htmodelist:JSON.stringify(n)}),!e.$getAutoSave())return e.$save("lafite")},this}]),e.register.value("WirelessEncryption",["none","psk+tkip+ccmp","psk2+tkip+ccmp","psk-mixed+tkip+ccmp"])}).call(this);